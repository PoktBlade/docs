# 4-3: Configure Nginx

<iframe id="ytplayer" type="text/html" width="720" height="405"
src="https://www.youtube.com/embed/Y7UTvIlHXRI?start=3310"
frameborder="0" allowfullscreen></iframe>

Nginx is a web server. We installed it in step 2 but we need to do some additional configuration. 

Nginx uses config files to define servers and routes for incoming requests. For Pocket nodes, nginx needs to relay public requests to a a local http server that pocket core is running. This is referred to as the proxy. We'll also need to proxy requests made by the pocket CLI. For example, when we run the command `pocket query height`, the CLI makes an http request to the node's local http server.

## Config Files

The nginx configuration files we're interested in are located in the `/etc/nginx/sites-available/` directory. In that directory there is a default configuration file named `default`. This is the configuration that is created when you install nginx. It was also modified when we installed the SSL certificate using certbot. So, at this point the default configuration looks something like this:

- Confirm the name of your SSL certificate
    ```bash
    sudo ls /etc/letsencrypt/live/
    ```
- Create a new file with nano
    ```bash
    sudo nano /etc/nginx/sites-available/pocket
    ```
- Add the following code but change the hostname to your pocket node's hostname:
    ```nginx {27,36-37}
    server {
        listen 80 default_server;
        listen [::]:80 default_server;

        root /var/www/html;

        index index.html index.htm index.nginx-debian.html;

        server_name _;

        location / {
            try_files $uri $uri/ =404;
        }
    }

    server {
        add_header Access-Control-Allow-Origin "*";
        listen 80 ;
        listen [::]:80 ;
        listen 8081 ssl;
        listen [::]:8081 ssl;

        root /var/www/html;

        index index.html index.htm index.nginx-debian.html;

        server_name node1.pokt.run;

        location / {
            try_files $uri $uri/ =404;
        }

        listen [::]:443 ssl ipv6only=on;
        listen 443 ssl;

        ssl_certificate /etc/letsencrypt/live/node1.pokt.run/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/node1.pokt.run/privkey.pem;

        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

        access_log /var/log/nginx/reverse-access.log;
        error_log /var/log/nginx/reverse-error.log;

        location ~* ^/v1/client/(dispatch|relay|challenge|sim) {
            proxy_pass http://127.0.0.1:8082;
            add_header Access-Control-Allow-Methods "POST, OPTIONS";
            allow all;
        }

        location = /v1 {
            add_header Access-Control-Allow-Methods "GET";
            proxy_pass http://127.0.0.1:8082;
            allow all;
        }
    }
    ```
- Save the change with <kbd>Ctrl</kbd> + <kbd>O</kbd>
- Exit nano with <kbd>Ctrl</kbd> + <kbd>X</kbd>
- Stop nginx with 
    ```bash
    sudo systemctl stop nginx
    ```
- Disable the default configuration
    ```bash
    sudo rm /etc/nginx/sites-enabled/default
    ```
- Enable the pocket configuration
    ```bash
    sudo ln -s /etc/nginx/sites-available/pocket /etc/nginx/sites-enabled/pocket
    ```
- Start nginx
    ```bash
    sudo systemctl start nginx
    ```